<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TEF Study â€” Supabase Sync</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', -apple-system, sans-serif; background: #0f0f1a; color: #e2e8f0; min-height: 100vh; padding: 20px; }
  .container { max-width: 620px; margin: 0 auto; }
  .top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
  h1 { font-size: 22px; font-weight: 800; color: #fff; }
  .sub { font-size: 12px; color: rgba(255,255,255,0.4); margin-top: 3px; }
  .lang { display: flex; gap: 4px; }
  .lang button { padding: 5px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.15); background: transparent; color: rgba(255,255,255,0.4); font-size: 11px; font-weight: 700; cursor: pointer; }
  .lang button.on { background: rgba(255,255,255,0.12); color: #fff; border-color: rgba(255,255,255,0.3); }
  .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
  .card h2 { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
  .card .desc { font-size: 11px; color: rgba(255,255,255,0.35); margin-bottom: 12px; line-height: 1.6; }
  .st { padding: 10px 14px; border-radius: 8px; font-size: 12px; margin-bottom: 16px; line-height: 1.5; }
  .st.ok { background: rgba(74,222,128,0.1); color: #4ade80; border: 1px solid rgba(74,222,128,0.2); }
  .st.err { background: rgba(239,68,68,0.1); color: #f87171; border: 1px solid rgba(239,68,68,0.2); }
  .st.info { background: rgba(96,165,250,0.1); color: #93c5fd; border: 1px solid rgba(96,165,250,0.2); }
  .st.warn { background: rgba(251,191,36,0.1); color: #fbbf24; border: 1px solid rgba(251,191,36,0.2); }
  button { padding: 10px 16px; border-radius: 8px; border: none; font-size: 13px; font-weight: 600; cursor: pointer; }
  button:disabled { opacity: 0.4; cursor: default; }
  .bg { background: rgba(74,222,128,0.2); color: #4ade80; }
  .bb { background: rgba(96,165,250,0.2); color: #93c5fd; }
  .br { background: rgba(239,68,68,0.15); color: #f87171; font-size: 11px; padding: 8px 14px; }
  .bo { background: transparent; border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.5); font-size: 11px; padding: 8px 12px; }
  .row { display: flex; gap: 8px; flex-wrap: wrap; }
  .tag { display: inline-block; padding: 3px 10px; border-radius: 5px; font-size: 11px; background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5); margin-right: 4px; }
  input[type="file"] { display: none; }
  label.fb { display: inline-flex; align-items: center; padding: 10px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; background: rgba(96,165,250,0.2); color: #93c5fd; }
  .log { margin-top: 16px; max-height: 220px; overflow-y: auto; font-size: 11px; color: rgba(255,255,255,0.35); background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; font-family: 'Consolas', monospace; line-height: 1.7; }
  .log .ok { color: #4ade80; } .log .err { color: #f87171; } .log .info { color: #93c5fd; }
  .diag-item { margin-bottom: 8px; font-size: 12px; line-height: 1.6; color: rgba(255,255,255,0.5); }
  .foot { font-size: 10px; color: rgba(255,255,255,0.2); margin-top: 12px; line-height: 1.6; }
  a { color: rgba(96,165,250,0.6); text-decoration: none; }
</style>
</head>
<body>
<div class="container">
  <div class="top">
    <div>
      <h1>ğŸ‡«ğŸ‡· TEF Study â€” Supabase Sync</h1>
      <div class="sub" id="t-sub"></div>
    </div>
    <div class="lang">
      <button id="btn-fr" class="on" onclick="setLang('fr')">FR</button>
      <button id="btn-en" onclick="setLang('en')">EN</button>
    </div>
  </div>

  <!-- Warning if in iframe / artifact -->
  <div id="sandbox-warn" class="st warn" style="display:none"></div>

  <div id="conn-st" class="st info"></div>

  <!-- Diagnostics -->
  <div id="diag" class="card" style="display:none; border-color:rgba(251,191,36,0.2)">
    <h2 style="color:#fbbf24" id="t-diag-title"></h2>
    <div class="desc" id="t-diag-desc"></div>
    <div id="diag-steps"></div>
    <div class="row" style="margin-top:10px">
      <button class="bo" id="btn-retry">â†»</button>
      <a href="https://supabase.com/dashboard/projects" target="_blank"><button class="bo" id="t-dashboard"></button></a>
    </div>
  </div>

  <!-- Upload -->
  <div class="card">
    <h2 style="color:#4ade80" id="t-up-title"></h2>
    <div class="desc" id="t-up-desc"></div>
    <div class="row">
      <label class="fb"><span id="t-choose"></span><input type="file" accept=".json" id="up-file"/></label>
      <button class="bb" id="btn-paste" style="margin-left:4px"><span id="t-paste"></span></button>
    </div>
    <div id="up-info" style="margin-top:8px;font-size:11px;color:rgba(255,255,255,0.3)"></div>
    <div style="margin-top:10px"><button class="bg" id="btn-push" disabled></button></div>
  </div>

  <!-- Download -->
  <div class="card">
    <h2 style="color:#93c5fd" id="t-dl-title"></h2>
    <div class="desc" id="t-dl-desc"></div>
    <div class="row"><button class="bb" id="btn-pull"></button><button class="bb" id="btn-copy-clip" style="margin-left:4px"></button></div>
    <div id="db-stats" style="margin-top:8px"></div>
  </div>

  <!-- Danger -->
  <div class="card" style="border-color:rgba(239,68,68,0.2)">
    <h2 style="color:#f87171" id="t-dg-title"></h2>
    <div class="desc" id="t-dg-desc"></div>
    <div class="row"><button class="br" id="btn-clear"></button></div>
  </div>

  <div class="foot" id="t-foot"></div>
  <div id="log" class="log" style="display:none"></div>
</div>

<script>
const TX = {
  fr: {
    sub: "Synchronisez vos donnÃ©es entre l'artifact Claude et votre base Supabase",
    sandbox_warn: "âš ï¸ Ce fichier est ouvert dans l'aperÃ§u Claude (sandbox) â€” Supabase est bloquÃ© ici. Veuillez TÃ‰LÃ‰CHARGER ce fichier et l'ouvrir directement dans votre navigateur (Chrome, Firefox, Safari).",
    checking: "â³ VÃ©rification de la connexion Supabase...",
    ok: "âœ… ConnectÃ©", err: "âŒ Erreur de connexion",
    diag_title: "ğŸ”§ Diagnostic",
    diag_desc: "La connexion a Ã©chouÃ©. Causes possibles :",
    diag: [
      "ğŸ”´ <strong>AperÃ§u Claude (sandbox)</strong> â€” Si vous voyez ceci dans Claude, tÃ©lÃ©chargez le fichier HTML et ouvrez-le dans votre navigateur.",
      "ğŸ”´ <strong>Projet en pause</strong> â€” Les projets Supabase gratuits se mettent en pause aprÃ¨s 7 jours d'inactivitÃ©. Allez sur le <a href='https://supabase.com/dashboard/projects' target='_blank'>dashboard</a> et cliquez Â« Restore Â».",
      "ğŸ”´ <strong>Tables manquantes</strong> â€” VÃ©rifiez que le script SQL a Ã©tÃ© exÃ©cutÃ© dans l'Ã©diteur SQL Supabase.",
      "ğŸ”´ <strong>RÃ©seau</strong> â€” VÃ©rifiez votre connexion internet."
    ],
    retry: "â†» RÃ©essayer", dashboard: "ğŸ”— Dashboard Supabase",
    up_title: "ğŸ“¤ Envoyer vers Supabase",
    up_desc: "Exportez un backup depuis l'artifact (ğŸ’¾ dans l'en-tÃªte), puis uploadez-le ici.",
    choose: "ğŸ“ Choisir un fichier backup JSON",
    paste: "ğŸ“‹ Coller depuis presse-papiers",
    push: "ğŸ“¤ Envoyer vers Supabase", pushing: "â³ Envoi...",
    dl_title: "ğŸ“¥ TÃ©lÃ©charger depuis Supabase",
    dl_desc: "TÃ©lÃ©chargez vos donnÃ©es Supabase en JSON pour les importer dans l'artifact via ğŸ’¾.",
    pull: "ğŸ“¥ TÃ©lÃ©charger tout", pulling: "â³ TÃ©lÃ©chargement...",
    copy_clip: "ğŸ“‹ Copier pour l'artifact", copied_clip: "âœ… CopiÃ© !",
    dg_title: "âš ï¸ Zone dangereuse",
    dg_desc: "Supprimer toutes les donnÃ©es de Supabase. IrrÃ©versible.",
    clear: "ğŸ—‘ï¸ Vider Supabase",
    confirm1: "âš ï¸ Supprimer TOUTES les donnÃ©es Supabase ?",
    confirm2: "DerniÃ¨re chance â€” irrÃ©versible !",
    w: "mots", q: "quiz", te: "temps",
    loaded: "Fichier chargÃ©", invalid: "âŒ Fichier invalide",
    sent: "envoyÃ©s", done: "âœ… Sync terminÃ©e !",
    dled: "âœ… TÃ©lÃ©chargÃ©", del: "Suppression...", sendw: "Envoi mots", sendq: "Envoi quiz", sendt: "Envoi temps",
    cleared: "ğŸ—‘ï¸ DonnÃ©es supprimÃ©es",
    foot: "Workflow : Artifact ğŸ’¾ Sauvegarder â†’ tÃ©lÃ©charger JSON â†’ ouvrir cette page â†’ ğŸ“¤ Envoyer. Restaurer : ğŸ“¥ TÃ©lÃ©charger â†’ importer via ğŸ’¾."
  },
  en: {
    sub: "Sync your data between the Claude artifact and your Supabase database",
    sandbox_warn: "âš ï¸ This file is open in the Claude preview (sandbox) â€” Supabase is blocked here. Please DOWNLOAD this file and open it directly in your browser (Chrome, Firefox, Safari).",
    checking: "â³ Checking Supabase connection...",
    ok: "âœ… Connected", err: "âŒ Connection error",
    diag_title: "ğŸ”§ Diagnostics",
    diag_desc: "Connection failed. Possible causes:",
    diag: [
      "ğŸ”´ <strong>Claude preview (sandbox)</strong> â€” If you see this inside Claude, download the HTML file and open it in your browser.",
      "ğŸ”´ <strong>Project paused</strong> â€” Free Supabase projects pause after 7 days of inactivity. Go to the <a href='https://supabase.com/dashboard/projects' target='_blank'>dashboard</a> and click 'Restore'.",
      "ğŸ”´ <strong>Missing tables</strong> â€” Make sure you ran the SQL setup script in the Supabase SQL Editor.",
      "ğŸ”´ <strong>Network</strong> â€” Check your internet connection."
    ],
    retry: "â†» Retry", dashboard: "ğŸ”— Supabase Dashboard",
    up_title: "ğŸ“¤ Push to Supabase",
    up_desc: "Export a backup from the artifact (ğŸ’¾ in header), then upload it here.",
    choose: "ğŸ“ Choose a backup JSON file",
    paste: "ğŸ“‹ Paste from clipboard",
    push: "ğŸ“¤ Push to Supabase", pushing: "â³ Pushing...",
    dl_title: "ğŸ“¥ Download from Supabase",
    dl_desc: "Download your Supabase data as JSON to import into the artifact via ğŸ’¾.",
    pull: "ğŸ“¥ Download all", pulling: "â³ Downloading...",
    copy_clip: "ğŸ“‹ Copy for artifact", copied_clip: "âœ… Copied!",
    dg_title: "âš ï¸ Danger zone",
    dg_desc: "Delete all Supabase data. This is irreversible.",
    clear: "ğŸ—‘ï¸ Clear all Supabase data",
    confirm1: "âš ï¸ Delete ALL Supabase data?",
    confirm2: "Last chance â€” irreversible!",
    w: "words", q: "quizzes", te: "tenses",
    loaded: "File loaded", invalid: "âŒ Invalid file",
    sent: "sent", done: "âœ… Sync complete!",
    dled: "âœ… Downloaded", del: "Deleting...", sendw: "Sending words", sendq: "Sending quizzes", sendt: "Sending tenses",
    cleared: "ğŸ—‘ï¸ All data deleted",
    foot: "Workflow: Artifact ğŸ’¾ Save â†’ download JSON â†’ open this page â†’ ğŸ“¤ Push. Restore: ğŸ“¥ Download â†’ import via ğŸ’¾."
  }
};

let L = "fr";
const t = k => TX[L][k] || k;
const $ = id => document.getElementById(id);

function setLang(l) {
  L = l;
  $("btn-fr").className = l === "fr" ? "on" : "";
  $("btn-en").className = l === "en" ? "on" : "";
  $("t-sub").textContent = t("sub");
  $("t-diag-title").textContent = t("diag_title");
  $("t-diag-desc").textContent = t("diag_desc");
  $("diag-steps").innerHTML = TX[l].diag.map(d => `<div class="diag-item">${d}</div>`).join("");
  $("btn-retry").textContent = t("retry");
  $("t-dashboard").textContent = t("dashboard");
  $("t-up-title").textContent = t("up_title");
  $("t-up-desc").textContent = t("up_desc");
  $("t-choose").textContent = t("choose");
  $("t-paste").textContent = t("paste");
  if (!$("btn-push").disabled) $("btn-push").textContent = t("push");
  else $("btn-push").textContent = t("push");
  $("t-dl-title").textContent = t("dl_title");
  $("t-dl-desc").textContent = t("dl_desc");
  $("btn-pull").textContent = t("pull");
  $("btn-copy-clip").textContent = t("copy_clip");
  $("t-dg-title").textContent = t("dg_title");
  $("t-dg-desc").textContent = t("dg_desc");
  $("btn-clear").textContent = t("clear");
  $("t-foot").textContent = t("foot");
  if ($("sandbox-warn").style.display !== "none") $("sandbox-warn").textContent = t("sandbox_warn");
}

// Supabase
const SB = "https://djkldplonhgtfgdurfwd.supabase.co";
const SK = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqa2xkcGxvbmhndGZnZHVyZndkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1ODU0ODIsImV4cCI6MjA4NzE2MTQ4Mn0.wxKScIqBPtu8rjpiuBNVQUhtbA5RN_93cqwswoNT1ac";
const HD = { apikey: SK, Authorization: `Bearer ${SK}`, "Content-Type": "application/json" };

const logEl = $("log");
function log(m, c="") { logEl.style.display="block"; logEl.innerHTML += `<div class="${c}">${new Date().toLocaleTimeString()} â€” ${m}</div>`; logEl.scrollTop=logEl.scrollHeight; }

async function sbGet(tb) { const r = await fetch(`${SB}/rest/v1/${tb}?select=*`, { headers: HD }); if(!r.ok) throw new Error(`GET ${tb}: ${r.status}`); return r.json(); }
async function sbIns(tb, rows) { const r = await fetch(`${SB}/rest/v1/${tb}`, { method:"POST", headers:{...HD, Prefer:"return=representation"}, body:JSON.stringify(rows) }); if(!r.ok){ const x=await r.text().catch(()=>""); throw new Error(`INSERT ${tb}: ${r.status} ${x}`); } return r.json(); }
async function sbDel(tb) { const r = await fetch(`${SB}/rest/v1/${tb}?id=gt.0`, { method:"DELETE", headers:HD }); if(!r.ok) throw new Error(`DEL ${tb}: ${r.status}`); }

// Detect sandbox
if (window.self !== window.top || window.location.protocol === "blob:") {
  $("sandbox-warn").style.display = "block";
  $("sandbox-warn").textContent = t("sandbox_warn");
}

async function testConn() {
  $("conn-st").className = "st info";
  $("conn-st").textContent = t("checking");
  $("diag").style.display = "none";
  try {
    const v = await sbGet("vocabulary");
    const q = await sbGet("quiz_history");
    const ts = await sbGet("custom_tenses");
    $("conn-st").className = "st ok";
    $("conn-st").textContent = `${t("ok")} â€” ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`;
    $("db-stats").innerHTML = `<span class="tag">ğŸ“ ${v.length} ${t("w")}</span><span class="tag">ğŸ“Š ${q.length} ${t("q")}</span><span class="tag">ğŸ”„ ${ts.length} ${t("te")}</span>`;
    log(`${t("ok")}: ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`, "ok");
    return true;
  } catch(e) {
    $("conn-st").className = "st err";
    $("conn-st").textContent = `${t("err")}: ${e.message}`;
    log(`${t("err")}: ${e.message}`, "err");
    $("diag").style.display = "block";
    return false;
  }
}

testConn();
$("btn-retry").onclick = testConn;
setLang("fr");

// Upload
let upData = null;
$("up-file").addEventListener("change", async e => {
  const f = e.target.files?.[0]; if(!f) return;
  try {
    upData = JSON.parse(await f.text());
    const v = upData.vocabulary || (Array.isArray(upData) ? upData : []);
    const q = upData.quizHistory || [];
    const ts = upData.customTenses || [];
    $("up-info").innerHTML = `âœ… <b>${f.name}</b> â€” ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`;
    $("btn-push").disabled = false;
    log(`${t("loaded")}: ${v.length} ${t("w")}, ${q.length} ${t("q")}`, "info");
  } catch(er) { $("up-info").textContent = t("invalid"); upData=null; $("btn-push").disabled=true; }
});

// Paste from clipboard
$("btn-paste").onclick = async () => {
  try {
    const text = await navigator.clipboard.readText();
    upData = JSON.parse(text);
    const v = upData.vocabulary || (Array.isArray(upData) ? upData : []);
    const q = upData.quizHistory || [];
    const ts = upData.customTenses || [];
    $("up-info").innerHTML = `âœ… <b>${t("paste")}</b> â€” ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`;
    $("btn-push").disabled = false;
    log(`${t("loaded")} (${t("paste")}): ${v.length} ${t("w")}, ${q.length} ${t("q")}`, "info");
  } catch(e) { $("up-info").textContent = t("invalid") + " â€” " + e.message; upData=null; $("btn-push").disabled=true; }
};

// Push
$("btn-push").onclick = async () => {
  if(!upData) return;
  $("btn-push").disabled=true; $("btn-push").textContent=t("pushing");
  try {
    const v = upData.vocabulary || (Array.isArray(upData) ? upData : []);
    const q = upData.quizHistory || [];
    const ts = upData.customTenses || [];
    log(t("del"), "info");
    try{await sbDel("vocabulary")}catch(e){} try{await sbDel("quiz_history")}catch(e){} try{await sbDel("custom_tenses")}catch(e){}
    if(v.length) {
      log(`${t("sendw")} (${v.length})...`, "info");
      for(let i=0; i<v.length; i+=50) {
        const batch = v.slice(i,i+50).map(x => ({ fr:x.fr, type:x.type||"nom", def:x.def||"", en:x.en||"", ex:x.ex||"", gender:x.gender||null, number:x.number||null, singular:x.singular||null, plural:x.plural||null, conj:x.conj||{}, counterpart:x.counterpart||null, category:x.category||null, added:x.added||new Date().toISOString() }));
        await sbIns("vocabulary", batch);
        log(`  ${Math.min(i+50,v.length)}/${v.length} ${t("sent")}`, "ok");
      }
    }
    if(q.length) { log(`${t("sendq")} (${q.length})...`, "info"); await sbIns("quiz_history", q.map(x => ({ quiz_type:x.quiz_type||"vocab", score_correct:x.score?.correct??0, score_total:x.score?.total??0, answers:x.answers||[], completed_at:x.date||new Date().toISOString() }))); }
    if(ts.length) { log(`${t("sendt")} (${ts.length})...`, "info"); await sbIns("custom_tenses", ts.map(x => ({ key:x.key, fr:x.fr, en:x.en, core:x.core||false }))); }
    log(`${t("done")} ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`, "ok");
    await testConn();
  } catch(e) { log(`âŒ ${e.message}`, "err"); }
  $("btn-push").disabled=false; $("btn-push").textContent=t("push");
};

// Pull
$("btn-pull").onclick = async () => {
  $("btn-pull").disabled=true; $("btn-pull").textContent=t("pulling");
  try {
    const v = await sbGet("vocabulary"), q = await sbGet("quiz_history"), ts = await sbGet("custom_tenses");
    const bk = {
      vocabulary: v.map(x => ({ fr:x.fr, type:x.type, def:x.def, en:x.en, ex:x.ex, gender:x.gender, number:x.number, singular:x.singular, plural:x.plural, conj:x.conj, counterpart:x.counterpart, category:x.category, added:x.added })),
      quizHistory: q.map(x => ({ quiz_type:x.quiz_type, score:{correct:x.score_correct,total:x.score_total}, answers:x.answers, date:x.completed_at })),
      customTenses: ts.map(x => ({ key:x.key, fr:x.fr, en:x.en, core:x.core })),
      exportDate: new Date().toISOString(), source:"supabase", version:"1.0"
    };
    const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([JSON.stringify(bk,null,2)],{type:"application/json"}));
    a.download = `tef-supabase-backup-${new Date().toISOString().slice(0,10)}.json`; a.click();
    log(`${t("dled")}: ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`, "ok");
  } catch(e) { log(`âŒ ${e.message}`, "err"); }
  $("btn-pull").disabled=false; $("btn-pull").textContent=t("pull");
};

// Copy to clipboard (for pasting into artifact)
$("btn-copy-clip").onclick = async () => {
  $("btn-copy-clip").disabled=true; $("btn-copy-clip").textContent=t("pulling");
  try {
    const v = await sbGet("vocabulary"), q = await sbGet("quiz_history"), ts = await sbGet("custom_tenses");
    const bk = {
      vocabulary: v.map(x => ({ fr:x.fr, type:x.type, def:x.def, en:x.en, ex:x.ex, gender:x.gender, number:x.number, singular:x.singular, plural:x.plural, conj:x.conj, counterpart:x.counterpart, category:x.category, added:x.added })),
      quizHistory: q.map(x => ({ quiz_type:x.quiz_type, score:{correct:x.score_correct,total:x.score_total}, answers:x.answers, date:x.completed_at })),
      customTenses: ts.map(x => ({ key:x.key, fr:x.fr, en:x.en, core:x.core })),
      exportDate: new Date().toISOString(), source:"supabase", version:"1.0"
    };
    await navigator.clipboard.writeText(JSON.stringify(bk));
    $("btn-copy-clip").textContent = t("copied_clip");
    log(`${t("copied_clip")} ${v.length} ${t("w")}, ${q.length} ${t("q")}, ${ts.length} ${t("te")}`, "ok");
    setTimeout(() => { $("btn-copy-clip").textContent = t("copy_clip"); }, 2000);
  } catch(e) { log(`âŒ ${e.message}`, "err"); }
  $("btn-copy-clip").disabled=false;
};

// Clear
$("btn-clear").onclick = async () => {
  if(!confirm(t("confirm1"))||!confirm(t("confirm2"))) return;
  try { await sbDel("vocabulary"); await sbDel("quiz_history"); await sbDel("custom_tenses"); log(t("cleared"),"err"); await testConn(); }
  catch(e) { log(`âŒ ${e.message}`, "err"); }
};
</script>
</body>
</html>
